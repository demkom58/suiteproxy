services:
  opencode-dev:
    build:
      context: ./opencode-dev
    container_name: opencode-dev
    ports:
      - "4096:4096"   # OpenCode Web UI
      - "43000:3000"   # Nuxt dev server
    volumes:
      # Mount project from host (rw) — edits sync both ways
      - ../../:/app
      # Separate volume for node_modules to avoid Win/Linux binary conflicts
      - ../volumes/node_modules:/app/node_modules
      # Persist bun cache across rebuilds
      - ../volumes/bun_cache:/root/.bun
      # Persist Camoufox binary (~260MB — avoid re-downloading)
      - ../volumes/camoufox_cache:/root/.cache/camoufox
      # Persist OpenCode sessions/history across container rebuilds
      - ../volumes/opencode_data:/root/.local/share/opencode
      # Persist OpenCode user config across container rebuilds
      - ../volumes/opencode_config:/root/.config/opencode
    environment:
      - DISPLAY=:99
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_PAT=${GITHUB_PAT}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PAT}
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    shm_size: "2gb"
    depends_on:
      openmemory:
        condition: service_healthy
    stdin_open: true
    tty: true
    restart: unless-stopped

  openmemory:
    build:
      context: ./openmemory
    container_name: openmemory
    ports:
      - "8787:8080"   # API at /api/memory/* | Dashboard at http://localhost:8787/
    volumes:
      - ../volumes/openmemory:/app/data
    environment:
      - PORT=8080
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/api/memory/list').then(r=>r.ok?process.exit(0):process.exit(1)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    restart: unless-stopped
