services:
  opencode-dev:
    build:
      context: ./opencode-dev
    container_name: opencode-dev
    ports:
      - "4096:4096"   # OpenCode Web UI
      - "43000:3000"   # Nuxt dev server
    volumes:
      # Mount project from host (rw) â€” edits sync both ways
      - ../../:/app
      # Separate volume for node_modules to avoid Win/Linux binary conflicts
      - node_modules:/app/node_modules
      # Persist bun cache across rebuilds
      - bun_cache:/root/.bun
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_PAT=${GITHUB_PAT}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PAT}
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      browser:
        condition: service_healthy
      openmemory:
        condition: service_healthy
    stdin_open: true
    tty: true
    restart: unless-stopped

  browser:
    image: lscr.io/linuxserver/msedge:latest
    container_name: msedge
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Kyiv
      - EDGE_CLI=--remote-debugging-port=9222 --remote-allow-origins=* --no-first-run --disable-background-networking --disable-default-apps --disable-extensions --disable-sync --no-default-browser-check
      - DOCKER_MODS=linuxserver/mods:universal-package-install
      - INSTALL_PACKAGES=socat
    ports:
      - "3100:3000"   # Edge GUI (HTTP)
      - "3101:3001"   # Edge GUI (HTTPS)
      - "9222:9223"   # CDP for Playwright (socat 0.0.0.0:9223 -> 127.0.0.1:9222)
    shm_size: "1gb"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - edge-config:/config
      - ./edge-init:/custom-cont-init.d:ro
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9223/json/version"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 30s
    restart: unless-stopped

  openmemory:
    build:
      context: ./openmemory
    container_name: openmemory
    ports:
      - "8787:8080"   # API at /api/memory/* | Dashboard at http://localhost:8787/
    volumes:
      - openmemory-data:/app/data
    environment:
      - PORT=8080
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/api/memory/list').then(r=>r.ok?process.exit(0):process.exit(1)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    restart: unless-stopped

volumes:
  node_modules:
  bun_cache:
  openmemory-data:
  edge-config:
